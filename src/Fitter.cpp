#include "Fitter.h"
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************SET DATA/INPUT**********************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
void Fitter::SetFit(TF1 *f_)
{
    f = f_;
};
TF1 *Fitter::GetFit()
{
    return f;
};

std::vector<std::vector<float>> Fitter::GetData()
{
    return data;
}

void Fitter::InputData(std::vector<std::vector<float>> vec)
{
    int N = vec.size();
    data.resize(N);

    for (int i = 0; i < N; i++)
    {
        data[i][0] = vec[i][0];
        data[i][1] = vec[i][1];
        data[i][2] = vec[i][2];
        data[i][3] = vec[i][3];
    }
};

void Fitter::SetData()
{
    std::fstream rFile("data.txt"); // read mode
    if (rFile.fail())
    {
        std::cout << "Error: Unable to load data file" << std::endl;
        exit(1);
    }
    std::string line;
    while (getline(rFile, line))
    {                               // loop on file lines
        std::stringstream ss(line); // build object stringstream
        float d;
        std::vector<float> temp;
        while (ss >> d)
        { // parse line words to numbers (empty space separated)
            temp.push_back(d);
        }
        ss.clear(); // erase stringstream contents
        data.push_back(temp);
    }
    rFile.close();
};

void Fitter::SetDataFromDataReader(std::string filename)
{
    DataReader S(filename);
    int N = S.GetData().size();
    data.resize(N);
    data = S.GetData();
};

/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************DATA DUMP***************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/

void Fitter::Print(std::string s)
{
    if (s == "data")
    {
        std::cout << "\n******************Data******************" << std::endl;
        for (int i = 0; i < data.size(); i++)
        {
            std::cout << "(" << std::setprecision(5) << data[i][0] << ", " << data[i][1] << ")"
                      << "; ex= " << data[i][2] << "; ey= " << data[i][3] << std::endl;
        }
    }
}  

/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************FIT AND FIT INFO********************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
void Fitter::GetFitInfo(TF1 *f_)
{
    std::cout << "\nChi Squared: " << std::setprecision(10) << f_->GetChisquare() << std::endl;
    //std::cout << "\nVariance: " << std::setprecision(10) << f_->Variance() << std::endl;
    std::cout << "Number of Free Parameters: " << f_->GetNumberFreeParameters() << std::endl;
    for (int i = 0; i < f_->GetNumberFreeParameters(); i++)
    {
        std::cout << "[" << i << "]"
                  << "\t" << f_->GetParName(i) << ":\t\t" << std::setprecision(5) << f_->GetParameters()[i] << " +/- " << f_->GetParErrors()[i] << std::endl;
    }
    std::cout << "\n"
              << std::endl;
};

void Fitter::fit()
{
    int n = data.size();
    TGraph *gr1 = new TGraph(n);
    for (int i = 0; i < n; i++)
    {
        gr1->SetPoint(i, data[i][0], data[i][1]);
    }
    gr1->Fit(f, "q");
};

/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************DRAW********************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/

void Fitter::DrawPoints()
{
    TCanvas *c = new TCanvas("c", "Points", 1280, 720);
    c->SetGrid();
    c->GetFrame()->SetFillColor(21);
    c->GetFrame()->SetBorderSize(12);
    int n = data.size();
    TGraph *gr = new TGraph();

    for (int i = 0; i < n; i++)
    {
        gr->SetPoint(i, data[i][0], data[i][1]);
    }

    gr->SetTitle("Points");
    gr->GetXaxis()->SetTitle("x");
    gr->GetYaxis()->SetTitle("y");
    gr->SetMarkerColor(kBlue);
    gr->SetMarkerStyle(21);
    gr->Draw("AP");
    // c->SaveAs("fitterpoints.pdf");
};

void Fitter::DrawFit()
{
    // BIU -_-

    // TApplication *app = new TApplication("app", nullptr, nullptr);
    TCanvas *c1 = new TCanvas("c1", "FIT", 1280, 720);

    // TRootCanvas *r = (TRootCanvas *)c1->GetCanvasImp();
    // r->Connect("CloseWindow()", "TApplication", gApplication, "Terminate()");

    c1->SetGrid();
    int n = data.size();
    TGraph *gr1 = new TGraph(n);

    for (int i = 0; i < n; i++)
    {
        gr1->SetPoint(i, data[i][0], data[i][1]);
    }

    gr1->Fit(f, "q");
    GetFitInfo(f);

    gr1->SetTitle("Fit");
    gr1->GetXaxis()->SetTitle("x");
    gr1->GetYaxis()->SetTitle("y");

    gr1->SetLineColor(69);
    gr1->SetLineWidth(4);
    gr1->SetMarkerColor(kBlue);
    gr1->SetMarkerStyle(21);
    gr1->Draw("AP");
    // c1->Update();
    c1->SaveAs("fitter.png");
    // app->Run();
};

void Fitter::DrawFitErrors()
{
    // TApplication *app = new TApplication("app", nullptr, nullptr);
    TCanvas *c2 = new TCanvas("c2", "FIT", 1280, 720);

    // TRootCanvas *r = (TRootCanvas *)c1->GetCanvasImp();
    // r->Connect("CloseWindow()", "TApplication", gApplication, "Terminate()");

    c2->SetGrid();
    int n = data.size();

    float_t x[n], y[n], ex[n], ey[n];

    for (int i = 0; i < n; i++)
    {
        x[i] = data[i][0];
        y[i] = data[i][1];
        ex[i] = data[i][2];
        ey[i] = data[i][3];
    }

    TGraphErrors *gr1 = new TGraphErrors(n, x, y, ex, ey);

    gr1->Fit(f, "q");
    GetFitInfo(f);

    gr1->SetTitle("Fit with Errors");
    gr1->GetXaxis()->SetTitle("x");
    gr1->GetYaxis()->SetTitle("y");

    gr1->SetLineColor(1);
    gr1->SetLineWidth(2);
    gr1->SetMarkerColor(kBlue);
    gr1->SetMarkerStyle(21);
    gr1->Draw("AP");
    // c1->Update();
    c2->SaveAs("fittererrors.png");
    // app->Run();
};

/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************EXTRAS******************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
std::pair<double, double> Fitter::Derivate(double x, double order)
{
    fit();
    std::pair<double, double> v;
    if (order == 1)
    {
        v.first = f->Derivative(x);
        v.second = f->DerivativeError();
    }
    if (order == 2)
    {
        v.first = f->Derivative2(x);
        v.second = f->DerivativeError();
    }
    if (order == 3)
    {
        v.first = f->Derivative3(x);
        v.second = f->DerivativeError();
    }
    return v;
}

double Fitter::Image(double x)
{
    fit();
    return f->Eval(x);
}

double Fitter::Integrate(double min, double max)
{
    fit();
    double value = f->Integral(min, max);
    return value;
}
